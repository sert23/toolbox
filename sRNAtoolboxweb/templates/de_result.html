{% extends "base.html" %}
{% load staticfiles %}


{% block header %}
{#<script type="text/javascript" src="http://kozea.github.com/pygal.js/javascripts/svg.jquery.js"></script>#}
<script type="text/javascript" src="js/svg.jquery.js"></script>
{#<script type="text/javascript" src="http://kozea.github.com/pygal.js/javascripts/pygal-tooltips.js"></script>#}
<script type="text/javascript" src="js/pygal-tooltips.js"></script>
<script src="{% static 'js/plotly-latest.min.js' %}"></script>
{#<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>#}
{% endblock %}


{% block content %}
{% load render_table from django_tables2 %}

<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">

            <h3 class="page-header">sRNAde Results for job ID: <a href="{{ settings.SUB_SITE }}/jobstatus/{{ id }}" class="alert-link">{{ id }}</a> </h3>

        </div>
        <!-- /.col-lg-12 -->
        <div class="col-lg-8">

            <p class="text-danger">The results will be stored for 15 days (This will be removed on:  {{ date|date:"D d M Y" }}).</p>

            <p class="text-primary">If you use the sRNAde please check <a data-toggle="modal" data-target="#HWTC" >How to Cite.</a></p>

        </div>
    </div>
    <!-- /.row -->
    <div class="row">

        <div class="col-lg-12">


            <div class="row">
            {% if parameters %}
                <div class="col-lg-6">
                <div class="panel panel-primary">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" href="#parameters">Parameters</a>
                    </h4>
                </div>
                <!-- .panel-heading -->
                <div id="parameters" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="col-lg-11">
                            <pre style="white-space: pre-line">
                                {{ parameters }}
                            </pre>
                        </div>
                    </div>
                </div>
                </div>
                </div>

                {% if zip %}
                <div class="col-lg-6">
                <div class="col-lg-12">
                    <br>

                <h4 class="text-success"> Download all results as zip file <a href="{{ zip }}" download> <i class="fa fa-file-zip-o fa-fw"></i> here</a></h4>
                </div>
                </div>
                {% endif %}

            {% endif %}
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="dropdown">
                      <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        Download
                        <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                        <li><a href="#">Expression matrix (read counts)</a></li>
                        <li><a href="#">Expression matrix (RPM)</a></li>
{#                        <li><a href="#">Something else here</a></li>#}
{#                        <li role="separator" class="divider"></li>#}
{#                        <li><a href="#">Separated link</a></li>#}
                      </ul>
                    </div>
                </div>
            </div>

            <!-- Nav tabs -->
            <div class="" role="tabpanel" data-example-id="togglable-tabs">
            <ul id="myTab" class="nav nav-tabs">

                <li class="active"><a href="#summary" data-toggle="tab">Results summary</a>
                </li>
                <li><a href="#preprocessing" data-toggle="tab">Preprocessing/QC</a>
                </li>
                <li><a href="#mapping_stats" data-toggle="tab">Mapping statistics</a>
                </li>
                <li><a href="#miRNA_isomiR_stats" data-toggle="tab">miRNA and isomiR statistics</a>
                </li>
                <li><a href="#DE" data-toggle="tab">Differential expression</a>
                </li>
                <!--<li><a href="#seq_variation" data-toggle="tab">Sequence variation</a>-->
                <!--</li>-->
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">

                <div class="tab-pane fade in active" id="summary">
                    <div class="x-content">
                        <div class="col-lg-12">

                        <div class="panel panel-primary" id="simple_summary">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#simple_summary_content">Methods summary</a>
                                    </h4>
                                </div>
                        <div id="simple_summary_content" class="panel-collapse collapse in">
                                    <div class="panel-body">
                                        <br>
{#                                        {% render_table methods_table.content %}#}

                                        {% for stable in summary_list %}
                                            <h4> {{ stable.name }}  </h4>
                                            {% render_table stable.content %}
                                        {% endfor %}

                                    </div>
                        </div>
                        </div>


                            <div class="panel panel-primary" id="map_stats">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#map_stats_content">Mapping statistics</a>
                                    </h4>
                                </div>
                                <!-- .panel-heading -->
                                <div id="map_stats_content" class="panel-collapse collapse in">
                                    <div class="panel-body">





                                        <!-- Percentage per detected RNA category -->
                                        {% if mapping_stat_sensePref_bp or mapping_stat_sensePref_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#mapping_stat_sp">{{ mapping_stat_sensePref_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="mapping_stat_sp" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                {% if mapping_stat_sensePref_bp %}
                                                    <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                        {{ mapping_stat_sensePref_bp|safe }}
                                                    </div>
                                                {% endif %}
                                                <br>
                                                {% if mapping_stat_sensePref_t %}
                                                    <div style="overflow: auto; margin-top: auto">
                                                        {% render_table mapping_stat_sensePref_t.content %}
                                                    </div>
                                                {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}



                                        <!--{% if mapping_stat_table %}-->
                                            <!--<h3>{{ mapping_stat_table.name }}</h3>-->
                                            <!--<div style="overflow: auto; margin-bottom: auto">-->
                                                <!--{% render_table mapping_stat_table.content %}-->
                                            <!--</div>-->
                                        <!--{% endif %}-->
                                        <br>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="preprocessing">
                    <div class="x-content">
                        <div class="col-lg-12">

                            <div class="panel panel-primary" id="preprocessing_summary">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#summary_content">Graphic Sequencing Statistics Summary</a>
                                    </h4>
                                </div>
                                <!-- .panel-heading -->
                                <div id="summary_content" class="panel-collapse collapse in">
                                    <div class="panel-body">

                                        <!-- Sequencing stats -->
                                        {% if sequencing_stat_t %}
                                            <div style="overflow: auto; margin-top: auto">
                                                {% render_table sequencing_stat_t.content %}
                                            </div>
                                        {% endif %}

                                        <!-- Preprocessing statistics -->
                                        {% if preproc_raw_bp or preproc_raw_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#preproc_raw">{{ preproc_raw_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="preproc_raw" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                     {% if preproc_raw_bp %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ preproc_raw_bp|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if preproc_raw_t %}
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table preproc_raw_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Preprocessing statistics -->
                                        {% if preproc_raw_bp or preproc_raw_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#preproc_perc">{{ preproc_perc_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="preproc_perc" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                     {% if preproc_perc_bp %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ preproc_perc_bp|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if preproc_perc_t %}
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table preproc_perc_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!--{% if length_plot %}-->
                                            <!--{{ length_plot|safe }}-->
                                        <!--{% endif %}-->

                                    </div>
                                </div>
                            </div>

                            <div class="panel panel-primary" id="preprocessing_read_length">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#read_length_content">Read Length Distribution</a>
                                    </h4>
                                </div>
                                <!-- .panel-heading -->
                                <div id="read_length_content" class="panel-collapse collapse in">
                                    <div class="panel-body">

                                        <!-- Read length distribution (full) -->
                                        {% if read_length_full_plot or read_length_full_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#read_length_full">{{ read_length_full_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="read_length_full" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                    {% if read_length_full_plot %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ read_length_full_plot|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if read_length_full_t %}
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table read_length_full_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Read length distribution (analysis) -->
                                        {% if read_length_analysis_plot or read_length_analysis_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#read_length_analysis">{{ read_length_analysis_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="read_length_analysis" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                    {% if read_length_analysis_plot %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ read_length_analysis_plot|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if read_length_analysis_t %}
                                                    <h3>{{ read_length_analysis_t.name }}</h3>
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table read_length_analysis_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Read length distribution (genome mapped) -->
                                        {% if read_length_genome_plot or read_length_genome_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#read_length_genome">{{ read_length_genome_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="read_length_genome" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                    {% if read_length_genome_plot %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ read_length_genome_plot|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if read_length_genome_t %}
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table read_length_genome_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="mapping_stats">
                    <div class="x-content">
                        <div class="col-lg-12">
                            <!-- Number of mapped or assigned reads -->
                                        {% if mapping_raw_bp or mapping_raw_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#mapping_raw">{{ mapping_raw_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="mapping_raw" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                    {% if mapping_raw_bp %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ mapping_raw_bp|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if mapping_raw_t %}
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table mapping_raw_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                        <!-- Percentage of mapped or assigned reads -->
                                        {% if mapping_perc_bp or mapping_perc_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#mapping_perc">{{ mapping_perc_t.name }}</a>
                                                </h4>
                                            </div>
                                            <div id="mapping_perc" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                {% if mapping_perc_bp %}
                                                    <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                        {{ mapping_perc_bp|safe }}
                                                    </div>
                                                {% endif %}
                                                <br>
                                                {% if mapping_perc_t %}
                                                    <div style="overflow: auto; margin-top: auto">
                                                        {% render_table mapping_perc_t.content %}
                                                    </div>
                                                {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                            <!-- Genome mapping distribution (HR=highly redundant reads) -->
                            {% if genome_mapping_t %}
                            <div class="panel panel-success">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#genome_mapping">{{ genome_mapping_t.name }}</a>
                                    </h4>
                                </div>
                                <div id="genome_mapping" class="panel-collapse collapse in">
                                    <div class="panel-body">

                                        <div class="col-lg-12">
                                            {% if genome_mapping_bp %}
                                                <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                    {{ genome_mapping_bp|safe }}
                                                </div>
                                            {% endif %}
                                            <br>
                                            {% if genome_mapping_t %}
                                                <div style="overflow: auto; margin-top: auto">
                                                    {% render_table genome_mapping_t.content %}
                                                </div>
                                            {% endif %}
                                        </div>

                                    </div>
                                </div>
                            </div>
                            {% endif %}

                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="miRNA_isomiR_stats">
                    <div class="x-content">
                        <div class="col-lg-12">

                            <!-- Detected number of miRNAs and precursor sequences -->
                                        {% if miRNA_raw_bp or miRNA_raw_t %}
                                        <div class="panel panel-success">
                                            <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" href="#miRNA_raw">Detected number of miRNAs and precursor sequences</a>
                                                </h4>
                                            </div>
                                            <div id="miRNA_raw" class="panel-collapse collapse in">
                                                <div class="panel-body">

                                                    <div class="col-lg-12">
                                                    {% if miRNA_raw_bp %}
                                                        <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                            {{ miRNA_raw_bp|safe }}
                                                        </div>
                                                    {% endif %}
                                                    <br>
                                                    {% if miRNA_raw_t %}
                                                        <div style="overflow: auto; margin-top: auto">
                                                            {% render_table miRNA_raw_t.content %}
                                                        </div>
                                                    {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                            <!-- Fraction of different isomiR classes per sample -->
                            {% if iso_sample_bp %}
                            <div class="panel panel-success">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#iso_sample">Fraction of different isomiR classes per sample</a>
                                    </h4>
                                </div>
                                <div id="iso_sample" class="panel-collapse collapse in">
                                    <div class="panel-body">

                                        <div class="col-lg-12">
                                        {% if iso_sample_bp %}
                                            <div style="width:100%; height:100%; padding:1px; border:thin solid black;">
                                                {{ iso_sample_bp|safe }}
                                            </div>
                                        {% endif %}
                                        </div>

                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if seq_var_link %}
                            <div class="panel panel-success">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#iso_sample">Sequence Variants Analysis</a>
                                    </h4>
                                </div>
                                <div id="seqvar" class="panel-collapse collapse in">
                                    <div class="panel-body">

                                        <div class="col-lg-12">

                                            <a href="{{ seq_var_link }}" target="_blank"> <button type="button"  class="btn btn-primary">Go to Sequence Variants Analysis</button> </a>
                                            <br>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Tables -->
                            {% if iso_NTA_A_t %}
                            <h3>{{ iso_NTA_A_t.name }}</h3>
                                <div style="overflow: auto; margin-top: auto">
                                    {% render_table iso_NTA_A_t.content %}
                                </div>
                            {% endif %}

                            {% if iso_NTA_U_t %}
                            <h3>{{ iso_NTA_U_t.name }}</h3>
                                <div style="overflow: auto; margin-top: auto">
                                    {% render_table iso_NTA_U_t.content %}
                                </div>
                            {% endif %}

                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="DE">
                    <div class="x-content">
                        <div class="col-lg-12">
                            <br>
                            <div class="panel panel-primary" id="per_method_summary">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#per_method_summary_content"> Per Method Reports</a>
                                    </h4>
                                </div>
                            <div id="per_method_summary_content" class="panel-collapse collapse in">
                                    <div class="panel-body">
                                {% render_table methods_table.content %}
                            </div>
                        </div>
                            </div>
                        </div>
                    <div class="col-lg-12">

                        <div class="panel panel-primary" id="consensus_summary">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#consensus_summary_content"> Consensus Differential Expression</a>
                                    </h4>
                                </div>
                        <div id="consensus_summary_content" class="panel-collapse collapse in">
                                    <div class="panel-body">

                                    <style>
                                    @media (min-width: 768px) {
                                {#    @media (min-width: 768px) {#}
                                      .modal-xl {
                                        width: 90%;
                                          height: 300%;
                                       max-width:1200px;
                                      }
                                    }
                                </style>



                                {% if consensus_plots %}
<div style="margin-bottom:10">
                                        {% for img,name in consensus_plots %}

                <div class="col-lg-6">
    {#                <a href="{{ MEDIA_URL }}{{ img  }}"  > <img src="{{ MEDIA_URL }}{{ img  }}"  alt="Heat Map" style="width:100%;height:100%" /> </a>#}
                    <h3 align="center"> {{ name }}  </h3>
                    <a href= ><img id="con_img{{ forloop.counter }}" src="{{ img  }}" alt="img" style="width:100%;height:100%;padding:1px;border:thin solid black;"  /> </a>

                </div>

                    <div class="modal" id="modal_test_con{{ forloop.counter }}" tabindex="-1" role="dialog" aria-labelledby="label" aria-hidden="true">
        {#	    <div class="modal-dialog" role="document">#}
                <div class="modal-dialog modal-xl" role="document">
                  <div class="modal-content" >
                    <div class="modal-body" >
                                <h3 align="center"> {{ name }}  </h3>
                             <img src="{{ img  }}"  alt="Heat Map" style="width:100%;height:100%" />

                            <!-- Plotly chart will be drawn inside this DIV -->
        {#	          <img style="display:block; margin-left:auto; margin-right:auto; width:100%;" src="{{ MEDIA_URL }}{{ sumimgs.0  }}">#}
        {#	          <h1 style="text-align: center;">hello there</h1>#}
                    </div>
                  </div>
                </div>
            </div>


        <script>
            $('#con_img{{ forloop.counter }}').click(function() {
             $("#modal_test_con{{ forloop.counter }}").modal('show');
        {#     alert("this is a test");#}
    {#         if (!document.getElementById("{{ div_id }}")){#}
    {#             $('#empty_div_mir{{ forloop.counter }}').append('{{ plot|escapejs }}');#}
    {#         }#}
            });


    {#     Plotly.relayout( "{{ div_id }}", { 'xaxis.autorange': true, 'yaxis.autorange': true });#}

    </script>
            {% endfor %}
                                            </div>

                                            {% endif %}
{#                                        {% render_table methods_table.content %}#}

                                        {% for stable in consensus_list %}

                                            <div>
                                            <h4> {{ stable.name }}  </h4>
                                            {% render_table stable.content %}
                                            </div>
                                        {% endfor %}






                                    </div>
                        </div>
                        </div>


                    </div>
                    </div>
                </div>

                <!--<div class="tab-pane fade" id="seq_variation">-->
                    <!--<div class="x-content">-->
                    <!--<p>Hi there sequence variation!</p>-->
                    <!--</div>-->
                <!--</div>-->

            </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block modals %}
{% include "Messages/de/HWTCde.html" %}
{% endblock %}


{% block js %}
<script src="{% static 'js/plugins/dataTables/jquery.dataTables.js' %}"></script>
<script src="{% static 'js/plugins/dataTables/dataTables.bootstrap.js' %}"></script>
<script>
    $('table').each(function() {
        if (this.id != "notformattable"){
            console.log(this.id);
            $(this).dataTable();
        }
    });
</script>

<script>
    $(document).ready(function() {
        if(location.hash) {
            $('a[href=' + location.hash + ']').tab('show');
        }
        $(document.body).on("click", "a[data-toggle]", function(event) {
            location.hash = this.getAttribute("href");
        });
    });
    $(window).on('popstate', function() {
        var anchor = location.hash || $("a[data-toggle=tab]").first().attr("href");
        $('a[href=' + anchor + ']').tab('show');
    });
</script>

<script>
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
    // alert("before");
        $('.plotly-graph-div').each(function(i, obj) {
    // alert("in");
        Plotly.relayout( obj.id, { 'xaxis.autorange': true, 'yaxis.autorange': true });
        });
    })
</script>

{% endblock %}